<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechWatchIT - Business Technology Monitor</title>
    
    <!-- CSS Frameworks -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6f42c1;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #198754;
            --info-color: #0dcaf0;
            --dark-color: #212529;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
        }

        /* Priority Alert Section */
        .priority-section {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        /* Technology Badges */
        .tech-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CVE & Security (Priority) */
        .tech-cve { background: linear-gradient(45deg, #dc3545, #e74c3c); color: white; }
        
        /* Business Technologies */
        .tech-office365 { background: linear-gradient(45deg, #0078d4, #106ebe); color: white; }
        .tech-windows { background: linear-gradient(45deg, #00bcf2, #0078d4); color: white; }
        .tech-sentinelone { background: linear-gradient(45deg, #663399, #8e44ad); color: white; }
        .tech-jumpcloud { background: linear-gradient(45deg, #ff6b35, #f7931e); color: white; }
        .tech-vmware { background: linear-gradient(45deg, #607c8a, #455a64); color: white; }
        .tech-redhat { background: linear-gradient(45deg, #ee0000, #cc0000); color: white; }
        .tech-rocky_linux { background: linear-gradient(45deg, #10b981, #059669); color: white; }
        
        /* Severity levels */
        .severity-critical { background: var(--danger-color); color: white; }
        .severity-high { background: #fd7e14; color: white; }
        .severity-medium { background: var(--warning-color); color: #212529; }
        .severity-low { background: var(--success-color); color: white; }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Business Categories */
        .category-cve {
            border-left: 4px solid var(--danger-color);
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, transparent 100%);
        }

        .category-business {
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(90deg, rgba(13, 110, 253, 0.1) 0%, transparent 100%);
        }

        .alert-floating {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
        }

        .status-online { background-color: var(--success-color); }
        .status-offline { background-color: var(--danger-color); }
        .status-warning { background-color: var(--warning-color); }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .stat-card {
                margin-bottom: 1rem;
            }
            .table-responsive {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>TechWatchIT</strong>
                <small class="ms-2 opacity-75">Business Monitor</small>
            </a>
            
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3">
                    <i class="fas fa-clock me-1"></i>
                    <span id="last-update">Loading...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Alerts -->
        <div id="alerts-container"></div>

        <!-- Priority CVE Section -->
        <div class="priority-section p-4 mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Critical Security Alerts (CVE Priority)
                    </h4>
                    <p class="mb-0 opacity-75">Real-time monitoring of critical vulnerabilities affecting your business technologies</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex justify-content-md-end">
                        <div class="me-4">
                            <h2 class="mb-0" id="cve-alerts-count">0</h2>
                            <small>CVE Alerts</small>
                        </div>
                        <div>
                            <h2 class="mb-0" id="critical-alerts-count">0</h2>
                            <small>Critical</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Statistics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-newspaper fa-2x text-primary"></i>
                            </div>
                        </div>
                        <h3 class="mb-1 fw-bold" id="total-articles">0</h3>
                        <p class="text-muted mb-0">Total Articles</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-shield-alt fa-2x text-danger"></i>
                            </div>
                        </div>
                        <h3 class="mb-1 fw-bold" id="security-alerts">0</h3>
                        <p class="text-muted mb-0">Security Alerts</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-building fa-2x text-warning"></i>
                            </div>
                        </div>
                        <h3 class="mb-1 fw-bold" id="business-tech-count">0</h3>
                        <p class="text-muted mb-0">Business Tech</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card">
                    <div class="card-body text-center p-4">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-clock fa-2x text-success"></i>
                            </div>
                        </div>
                        <h3 class="mb-1 fw-bold" id="last-24h-count">0</h3>
                        <p class="text-muted mb-0">Last 24h</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Charts -->
        <div class="row mb-4">
            <!-- Filters -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filters & Search
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Technology</label>
                            <select class="form-select" id="tech-filter">
                                <option value="">All Technologies</option>
                                <optgroup label="🚨 Security & CVE">
                                    <option value="cve">CVE & Security Alerts</option>
                                </optgroup>
                                <optgroup label="💼 Business Technologies">
                                    <option value="office365">Office 365</option>
                                    <option value="windows">Windows</option>
                                    <option value="sentinelone">SentinelOne</option>
                                    <option value="jumpcloud">JumpCloud</option>
                                    <option value="vmware">VMware</option>
                                    <option value="redhat">Red Hat</option>
                                    <option value="rocky_linux">Rocky Linux</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Severity</label>
                            <select class="form-select" id="severity-filter">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Time Period</label>
                            <select class="form-select" id="period-filter">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="cve-only-filter">
                            <label class="form-check-label fw-semibold" for="cve-only-filter">
                                CVE & Security Only
                            </label>
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-primary" id="apply-filters">
                                <i class="fas fa-search me-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Technology Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="tech-summary" class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Technology</th>
                                        <th class="text-center">Articles</th>
                                        <th class="text-center">Alerts</th>
                                    </tr>
                                </thead>
                                <tbody id="tech-summary-body">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Security Alerts Timeline (30 days)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 350px;">
                            <canvas id="alerts-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Articles Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Recent Articles
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="export-articles">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="admin-toggle">
                                <i class="fas fa-cog me-1"></i> Admin
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="search-articles" 
                                           placeholder="Search articles...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sort-articles">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="severity-desc">Severity (High→Low)</option>
                                    <option value="tech-asc">Technology (A→Z)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" id="search-btn">
                                        <i class="fas fa-search me-1"></i> Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Articles Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Technology</th>
                                        <th>Title</th>
                                        <th class="text-center">Severity</th>
                                        <th class="text-center">CVSS</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="articles-table-body">
                                    <tr>
                                        <td colspan="6" class="loading">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Loading articles...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav>
                            <ul class="pagination justify-content-center" id="articles-pagination">
                                <!-- Dynamically generated -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="row mt-4" style="display: none;">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>Admin Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-3">
                            <button class="btn btn-primary" id="manual-fetch">
                                <i class="fas fa-download me-2"></i>
                                Fetch RSS Feeds
                            </button>
                            
                            <button class="btn btn-success" id="process-articles">
                                <i class="fas fa-robot me-2"></i>
                                Process with AI
                            </button>
                            
                            <button class="btn btn-warning" id="send-digest">
                                <i class="fas fa-envelope me-2"></i>
                                Send Daily Digest
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>System Health
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <span class="status-indicator status-online"></span>API Server
                                </span>
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <span class="status-indicator" id="db-indicator"></span>MySQL Database
                                </span>
                                <span class="badge bg-secondary" id="db-status">Checking...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <span class="status-indicator" id="openai-indicator"></span>OpenAI API
                                </span>
                                <span class="badge bg-secondary" id="openai-status">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Article Detail Modal -->
    <div class="modal fade" id="articleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="articleModalTitle">Article Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="articleModalBody">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="articleExternalLink" href="#" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-1"></i>
                        View Original
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <script>
        // API Configuration
        const API_BASE = window.location.origin;
        
        // Global Variables
        let currentArticles = [];
        let filteredArticles = [];
        let alertsChart = null;
        
        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getTechBadgeClass(tech) {
            return `tech-badge tech-${tech || 'other'}`;
        }
        
        function getSeverityBadgeClass(severity) {
            return `tech-badge severity-${severity || 'medium'}`;
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('alerts-container').appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Data Loading Functions
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats/summary`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.summary;
                    document.getElementById('total-articles').textContent = stats.total_articles || 0;
                    document.getElementById('security-alerts').textContent = stats.security_alerts || 0;
                    document.getElementById('business-tech-count').textContent = stats.business_tech_count || 0;
                    document.getElementById('last-24h-count').textContent = stats.last_24h_count || 0;
                    document.getElementById('cve-alerts-count').textContent = stats.cve_alerts || 0;
                    document.getElementById('critical-alerts-count').textContent = stats.critical_count || 0;
                    
                    document.getElementById('last-update').textContent = 
                        'Updated: ' + formatDate(stats.last_update);
                }
                
                await loadCharts();
                
            } catch (error) {
                console.error('Error loading stats:', error);
                showAlert('Error loading dashboard statistics', 'warning');
            }
        }
        
        async function loadCharts() {
            try {
                const periodFilter = document.getElementById('period-filter').value;
                const response = await fetch(`${API_BASE}/api/stats?days_back=${periodFilter}`);
                const data = await response.json();
                
                if (data.stats) {
                    createAlertsChart(data.stats.daily_evolution);
                    createTechSummary(data.stats.by_technology);
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }
        
        function createAlertsChart(dailyData) {
            const ctx = document.getElementById('alerts-chart').getContext('2d');
            
            if (alertsChart) {
                alertsChart.destroy();
            }
            
            const last7Days = dailyData.slice(0, 7).reverse();
            const labels = last7Days.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const articlesData = last7Days.map(d => d.articles);
            const alertsData = last7Days.map(d => d.alerts);
            
            alertsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Articles',
                        data: articlesData,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Security Alerts',
                        data: alertsData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function createTechSummary(techData) {
            const tbody = document.getElementById('tech-summary-body');
            
            if (techData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            // Sort by alerts (descending), then by count
            techData.sort((a, b) => (b.alerts - a.alerts) || (b.count - a.count));
            
            tbody.innerHTML = techData.map(tech => `
                <tr class="${tech.technology === 'cve' ? 'category-cve' : 'category-business'}">
                    <td>
                        <span class="tech-badge tech-${tech.technology}">
                            ${tech.technology.toUpperCase().replace('_', ' ')}
                        </span>
                    </td>
                    <td class="text-center fw-bold">${tech.count}</td>
                    <td class="text-center">
                        <span class="badge ${tech.alerts > 0 ? 'bg-danger' : 'bg-secondary'}">
                            ${tech.alerts}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadArticles() {
            try {
                const techFilter = document.getElementById('tech-filter').value;
                const severityFilter = document.getElementById('severity-filter').value;
                const periodFilter = document.getElementById('period-filter').value;
                const cveOnlyFilter = document.getElementById('cve-only-filter').checked;
                
                let url = `${API_BASE}/api/articles?limit=100&days_back=${periodFilter}`;
                if (techFilter) url += `&technology=${techFilter}`;
                if (severityFilter) url += `&severity=${severityFilter}`;
                if (cveOnlyFilter) url += `&security_only=true`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    currentArticles = data.articles;
                    filteredArticles = [...currentArticles];
                    renderArticlesTable();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading articles:', error);
                showAlert('Error loading articles', 'danger');
                document.getElementById('articles-table-body').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading articles
                    </td></tr>
                `;
            }
        }
        
        function renderArticlesTable() {
            const tbody = document.getElementById('articles-table-body');
            
            if (filteredArticles.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">
                        <i class="fas fa-inbox me-2"></i>
                        No articles found
                    </td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredArticles.slice(0, 50).map(article => `
                <tr class="${article.technology === 'cve' ? 'category-cve' : 'category-business'}">
                    <td class="text-nowrap">${formatDate(article.published_date)}</td>
                    <td>
                        <span class="${getTechBadgeClass(article.technology)}">
                            ${(article.technology || 'other').toUpperCase().replace('_', ' ')}
                        </span>
                    </td>
                    <td>
                        <a href="${article.link}" target="_blank" class="text-decoration-none fw-semibold">
                            ${article.title}
                        </a>
                        ${article.is_security_alert ? '<i class="fas fa-shield-alt text-danger ms-2" title="Security Alert"></i>' : ''}
                    </td>
                    <td class="text-center">
                        <span class="${getSeverityBadgeClass(article.severity_level)}">
                            ${(article.severity_level || 'medium').toUpperCase()}
                        </span>
                    </td>
                    <td class="text-center">
                        ${article.cvss_score ? `<strong class="text-danger">${article.cvss_score}</strong>` : '-'}
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="showArticleDetails(${article.id})" title="AI Summary">
                                <i class="fas fa-robot"></i>
                            </button>
                            <a href="${article.link}" target="_blank" class="btn btn-outline-primary" title="Original Article">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const dbStatus = document.getElementById('db-status');
                const dbIndicator = document.getElementById('db-indicator');
                
                if (data.database === 'OK') {
                    dbStatus.textContent = 'Connected';
                    dbStatus.className = 'badge bg-success';
                    dbIndicator.className = 'status-indicator status-online';
                } else {
                    dbStatus.textContent = 'Error';
                    dbStatus.className = 'badge bg-danger';
                    dbIndicator.className = 'status-indicator status-offline';
                }
                
                const openaiStatus = document.getElementById('openai-status');
                const openaiIndicator = document.getElementById('openai-indicator');
                
                if (data.openai === 'OK') {
                    openaiStatus.textContent = 'Configured';
                    openaiStatus.className = 'badge bg-success';
                    openaiIndicator.className = 'status-indicator status-online';
                } else {
                    openaiStatus.textContent = 'Not Configured';
                    openaiStatus.className = 'badge bg-warning';
                    openaiIndicator.className = 'status-indicator status-warning';
                }
                
            } catch (error) {
                console.error('Error checking system health:', error);
            }
        }
        
        // Admin Functions
        async function triggerManualFetch() {
            const btn = document.getElementById('manual-fetch');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/fetch`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        loadDashboardStats();
                        loadArticles();
                    }, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error manual fetch:', error);
                showAlert('Error fetching RSS feeds', 'danger');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initial load
            loadDashboardStats();
            loadArticles();
            checkSystemHealth();
            
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', function() {
                const btn = this;
                const icon = btn.querySelector('i');
                
                icon.classList.add('fa-spin');
                
                Promise.all([
                    loadDashboardStats(),
                    loadArticles(),
                    checkSystemHealth()
                ]).finally(() => {
                    icon.classList.remove('fa-spin');
                });
            });
            
            // Filter button
            document.getElementById('apply-filters').addEventListener('click', () => {
                loadArticles();
                loadCharts();
            });
            
            // Admin toggle
            document.getElementById('admin-toggle').addEventListener('click', function() {
                const adminSection = document.getElementById('admin-section');
                const isVisible = adminSection.style.display !== 'none';
                adminSection.style.display = isVisible ? 'none' : 'block';
                this.innerHTML = isVisible ? 
                    '<i class="fas fa-cog me-1"></i> Admin' : 
                    '<i class="fas fa-times me-1"></i> Close';
            });
            
            // Admin actions
            document.getElementById('manual-fetch').addEventListener('click', triggerManualFetch);
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                loadDashboardStats();
                loadArticles();
            }, 5 * 60 * 1000);
        });
        
        // Article details function
        async function showArticleDetails(articleId) {
            const modal = new bootstrap.Modal(document.getElementById('articleModal'));
            const modalBody = document.getElementById('articleModalBody');
            
            modalBody.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading article details...</p>
                </div>
            `;
            
            modal.show();
            
            try {
                const response = await fetch(`${API_BASE}/api/articles/${articleId}`);
                const article = await response.json();
                
                document.getElementById('articleModalTitle').textContent = article.title;
                document.getElementById('articleExternalLink').href = article.link;
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle me-2"></i>Article Information
                                    </h6>
                                    <p><strong>Date:</strong> ${formatDate(article.published_date)}</p>
                                    <p><strong>Technology:</strong> 
                                        <span class="${getTechBadgeClass(article.technology)}">
                                            ${(article.technology || 'other').toUpperCase().replace('_', ' ')}
                                        </span>
                                    </p>
                                    <p><strong>Severity:</strong> 
                                        <span class="${getSeverityBadgeClass(article.severity_level)}">
                                            ${(article.severity_level || 'medium').toUpperCase()}
                                        </span>
                                    </p>
                                    ${article.cvss_score ? `<p><strong>CVSS Score:</strong> <span class="text-danger fw-bold">${article.cvss_score}</span></p>` : ''}
                                    ${article.is_security_alert ? '<p><span class="badge bg-danger"><i class="fas fa-shield-alt me-1"></i>Security Alert</span></p>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card border-0 bg-primary bg-opacity-10">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-robot me-2"></i>AI Analysis
                                    </h6>
                                    ${article.ai_summary ? `
                                        <div class="bg-white rounded p-3">
                                            <h6 class="text-primary"><i class="fas fa-file-text me-2"></i>Summary</h6>
                                            <p>${article.ai_summary.replace(/\\n/g, '<br>')}</p>
                                        </div>
                                    ` : '<p class="text-muted">No AI summary available</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${article.content ? `
                        <div class="card border-0 mt-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-file-alt me-2"></i>Article Content
                                </h6>
                                <div class="bg-light rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    ${article.content.substring(0, 1000)}${article.content.length > 1000 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
                
            } catch (error) {
                console.error('Error loading article:', error);
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading article details
                    </div>
                `;
            }
        }
    </script>
</body>
</html>